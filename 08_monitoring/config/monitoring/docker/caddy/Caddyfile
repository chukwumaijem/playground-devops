{
    admin off
}


# Only expose Grafana to public
grafana.{$ROOT_DOMAIN} {
    reverse_proxy grafana:3000
}

# Global matcher for internal network access
@internal_network {
    remote_ip private_ranges 10.0.0.0/8 172.16.0.0/12 192.168.0.0/16
}

# Internal endpoints (only accessible via private network)
:9095 {
    # Allow log pushing from prod/staging Promtail instances
    handle @internal_network {
        reverse_proxy loki:3100 {
            header_up Host {upstream_hostport}
        }
    }
    respond 403  # Block all other access
}

:4319 {
    handle @internal_network {
        reverse_proxy opentelemetry-collector:4317 {
            header_up Host {upstream_hostport}
        }
    }
    respond 403
}