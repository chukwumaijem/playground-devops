---
# Playbook must set: egress_proxy_src, egress_proxy_dest, caddy_proxy_bind_ip (for Caddy bind).

- name: Ensure destination directory exists
  ansible.builtin.file:
    path: "{{ egress_proxy_dest }}"
    state: directory
    mode: "0755"
  become: true

- name: Deploy Caddyfile.egress (template with caddy_proxy_bind_ip for bind)
  ansible.builtin.template:
    src: "{{ egress_proxy_src }}/Caddyfile.egress"
    dest: "{{ egress_proxy_dest }}/Caddyfile.egress"
    mode: "0644"
  become: true

- name: Copy Dockerfile.egress
  ansible.builtin.copy:
    src: "{{ egress_proxy_src }}/Dockerfile.egress"
    dest: "{{ egress_proxy_dest }}/Dockerfile.egress"
    mode: "0644"
  become: true

- name: Copy docker-compose.proxy.yml
  ansible.builtin.copy:
    src: "{{ egress_proxy_src }}/docker-compose.proxy.yml"
    dest: "{{ egress_proxy_dest }}/docker-compose.proxy.yml"
    mode: "0644"
  become: true

- name: Copy docker-compose.app.yml
  ansible.builtin.copy:
    src: "{{ egress_proxy_src }}/docker-compose.app.yml"
    dest: "{{ egress_proxy_dest }}/docker-compose.app.yml"
    mode: "0644"
  become: true
