{
  email {$CADDY_EMAIL}
  acme_dns cloudflare {$CLOUDFLARE_API_TOKEN}
  on_demand_tls {
    ask http://admin:3000/api/check-domain
  }
}

# Handle vanity URLs for storage buckets.
public.storage.{$APP_DOMAIN} {
  reverse_proxy https://{$STORAGE_BUCKET_HOST} {
    header_up Host {http.reverse_proxy.upstream.hostport}
  }

  # Rewrite requests to include "/public" before forwarding
  @allRequests path_regexp .*
  rewrite @allRequests /{$NODE_ENV}/apps/public{uri}
}

private.storage.{$APP_DOMAIN} {
  reverse_proxy https://{$STORAGE_BUCKET_HOST} {
    header_up Host {http.reverse_proxy.upstream.hostport}
  }

  # Rewrite requests to include "/private" before forwarding
  @allRequests path_regexp .*
  rewrite @allRequests /{$NODE_ENV}/apps/private{uri}
}

# Redirect www to non-www for marketing site
www.{$APP_DOMAIN} {
    redir https://{$APP_DOMAIN}{uri} 301
}

# forward all app subdomain requests to admin app
app.{$APP_DOMAIN}, *.{$APP_DOMAIN}, *.*.{$APP_DOMAIN} {
  @managerRoutes path /api/manage*          # All requests starting with /api/manage
  @notManagerRoutes not path /api/manage*   # Everything else

  encode zstd gzip

  handle @managerRoutes {
    # disables compression in this block for streaming
    encode {
    }
    reverse_proxy manager:3001 {
      flush_interval -1  # critical to allow streaming
      transport http {
        read_timeout 5m   # timeout for reading response from manager
        write_timeout 5m  # timeout for writing request to manager
        dial_timeout 10s  # timeout for establishing connection
      }
      header_up X-Real-IP {remote_host}
      header_up X-Forwarded-For {remote_host}
      header_up X-Forwarded-Proto {scheme}
    }
  }

  handle @notManagerRoutes {
    reverse_proxy admin:3000 {
      transport http {
        read_timeout 2m   # timeout for reading response from admin
        write_timeout 30s # timeout for writing request to admin
        dial_timeout 10s  # timeout for establishing connection
      }
      header_up X-Real-IP {remote_host}
      header_up X-Forwarded-For {remote_host}
      header_up X-Forwarded-Proto {scheme}
    }
  }
}

# handle all customer custom domains for client app (routed through admin app)
https:// {
  tls {
    on_demand
  }
  encode zstd gzip
  reverse_proxy admin:3000 {
    transport http {
      read_timeout 2m   # timeout for reading response from admin
      write_timeout 30s # timeout for writing request to admin
      dial_timeout 10s  # timeout for establishing connection
    }
    header_up X-Real-IP {remote_host}
    header_up X-Forwarded-For {remote_host}
    header_up X-Forwarded-Proto {scheme}
  }
}